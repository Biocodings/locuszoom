<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LocusZoom Plugin Demo</title>

  <script src="https://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>

  <script src="locuszoom.vendor.min.js" type="text/javascript"></script>
  <script src="locuszoom.app.js" type="text/javascript"></script>
  <link rel="stylesheet" type="text/css" href="locuszoom.css"/>

  <script type="text/javascript">
    var apiBase = "http://portaldev.sph.umich.edu/api_internal_dev/v1/";
    var ds = new LocusZoom.DataSources();
    ds.addSource("base", ["AssociationLZ", {url:apiBase + "single/", params: {analysis: 3}}]);
    ds.addSource("ld", ["LDLZ" ,apiBase + "pair/LD/"]);
    ds.addSource("gene", ["GeneLZ", apiBase + "annotation/genes/"]);

    // Variable to store our demo instance
    var demo_instance;

    var topHits = [
      ["16:53819169", "FTO"],
      ["9:22051670", "CDKN2A/B"],
      ["7:28196413", "JAZF1"],
      ["19:33909710", "PEPD"],
      ["19:46158513", "GIPR"],
      ["12:71433293", "TSPAN8/LGR5"],
      ["10:114758349", "TCF7L2"],
      ["8:95937502", "TP53INP1"],
      ["2:27741237", "GCKR"],
      ["6:20679709", "CDKAL1"],
      ["2:161346447", "RBMS1"],
      ["16:75247245", "BCAR1"],
      ["15:77832762", "HMG20A"],
      ["7:15052860", "DGKB"],
      ["5:76427311", "ZBED3"]
    ];

    // Apply form data to a remapping of the demo LocusZoom instance
    function handleFormSubmit(lz_id){
      //var chr   = $("#" + lz_id + "_chr")[0].value;
      //var start = $("#" + lz_id + "_start")[0].value;
      //var end   = $("#" + lz_id + "_end")[0].value;
      var target =  $("#" + lz_id + "_region")[0].value.split(":");
      var chr = target[0];
      var pos = target[1];
      var start = 0;
      var end = 0;
      if ( pos.match(/[-+]/) ) {
        if (pos.match(/[-]/)) {
          pos = pos.split("-");
          start = +pos[0];
          end = +pos[1];
        } else {
          pos = pos.split("+");
          start = (+pos[0]) - (+pos[1]);
          end = (+pos[0]) + (+pos[1]);
        }
      } else {
        start = +pos - 300000
        end = +pos + 300000
      }
      demo_instance.mapTo(chr, start, end);
    }

    function jumpTo(region) {
      var target = region.split(":");
      var chr = target[0];
      var pos = target[1];
      var start = 0;
      var end = 0;
      if (!pos.match(/[-+]/)) {
        start = +pos - 300000
        end = +pos + 300000
      }
      demo_instance.state.ldrefvar = "";
      demo_instance.mapTo(chr, start, end);
      populateForms();
      return(false);
    }

    // Fill demo forms with values already loaded into LocusZoom objects
    function populateForms(){
      $("#lz-1_region")[0].value = demo_instance.state.chr + ":"
                                 + demo_instance.state.start + "-"
                                 + demo_instance.state.end;
    }

    function listHits() {
      $("#tophits").empty().append("<ul>").children(0).append(topHits.map(function(e) {
        return "<li><a href='javascript:jumpTo(\"" + e[0] + "\");'>" + e[1] + " </a></li>";
      }))
    }

    function initPage() {
      listHits();
      demo_instance = LocusZoom.populate(".lz-instance", ds);
      populateForms();
      $("#lz-1_hits").html(topHits.map(function(k) {return "<option>" + k + "</option>"}).join(""));
    };

    function stringifyLocusZoomStylesheet(){
      var css_string = "";
      for (var stylesheet in Object.keys(document.styleSheets)){
        if (   document.styleSheets[stylesheet].cssRules.length
            && document.styleSheets[stylesheet].cssRules[0].cssText != "undefined"
            && document.styleSheets[stylesheet].cssRules[0].cssText.indexOf(".lz-locuszoom") == 0){
          for (var rule in document.styleSheets[stylesheet].cssRules){
            if (typeof document.styleSheets[stylesheet].cssRules[rule].cssText != "undefined"){
              css_string += document.styleSheets[stylesheet].cssRules[rule].cssText + " ";
            }
          }
          break;
        }
      }
      return css_string;
    }

    var container = '';
    function generateExportPayload(){
      // Insert a hidden div, clone the node into that so we can modify it with d3
      var container = d3.select(demo_instance.svg.node().parentNode.parentNode)
        .append("div").style("display", "none")
        .html(d3.select(demo_instance.svg.node().parentNode).html());
      // Remove unnecessary elements
      container.selectAll("g.lz-curtain").remove();
      container.selectAll("g.lz-ui").remove();
      // Add the contents of the locuszoom stylesheet to the svg using string concatenation
      // Don't add this with d3 because it will escape the CDATA declaration incorrectly
      var initial_html = d3.select(container.select("svg").node().parentNode).html();
      var style_def = "<style type=\"text/css\"><![CDATA[\n" + stringifyLocusZoomStylesheet() + "\n]]></style>";
      var insert_at = initial_html.indexOf('>') + 1;
      initial_html = initial_html.slice(0,insert_at) + style_def + initial_html.slice(insert_at);
      var base64_svg = btoa(encodeURIComponent(initial_html).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
      }));
      return base64_svg;
      // Delete the container node
      container.remove();
    }

    function generateExportLink() {
      
      // Insert a hidden div, clone the node into that so we can modify it with d3
      var container = d3.select(demo_instance.svg.node().parentNode.parentNode)
        .append("div").style("display", "none")
        .html(d3.select(demo_instance.svg.node().parentNode).html());
      
      // Remove unnecessary elements
      container.selectAll("g.lz-curtain").remove();
      container.selectAll("g.lz-ui").remove();

      // Pull the svg into a string and add the contents of the locuszoom stylesheet
      // Don't add this with d3 because it will escape the CDATA declaration incorrectly
      var initial_html = d3.select(container.select("svg").node().parentNode).html();
      var style_def = "<style type=\"text/css\"><![CDATA[\n" + stringifyLocusZoomStylesheet() + "\n]]></style>";
      var insert_at = initial_html.indexOf('>') + 1;
      initial_html = initial_html.slice(0,insert_at) + style_def + initial_html.slice(insert_at);

      // Delete the container node
      container.remove();      

      // Base64-encode the string
      var base64_svg = btoa(encodeURIComponent(initial_html).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
      }));

      // Create the download link
      d3.selectAll("#export a").remove();
      d3.select("#export").append("a")
        .attr("href-lang", "image/svg+xml")
        .attr("href", "data:image/svg+xml;base64,\n" + base64_svg)
        .attr("title", "locuszoom.svg")
        .text("Download SVG");
      
    }
  </script>
</head>
<body style="background-color: #CCCCCC; margin: 10px;" onload="initPage()">
  <table border="0" cellspacing="10">
    <tr>
      <td>
        <div>
          <form>
            <b>lz-1</b> &middot;
            <label for="lz-1_region">Region: </label>
            <input type="text" size=25 id="lz-1_region">
            <input type="button" id="lz-1_submit" value="Go" onClick="handleFormSubmit('lz-1');" />
          </form>
          <br>
        </div>
        <div id="lz-1" class="lz-instance" data-region="10:114550452-115067678"></div>
      </td>
      <td style="vertical-align:top">
        <h3>Top Hits</h3>
        <div id="tophits"></div>
        <div>
          <button onclick="generateExportLink()">Export SVG</button>
        </div>
        <div id="export" style="margin-top: 10px; font-weight: 700;">
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
